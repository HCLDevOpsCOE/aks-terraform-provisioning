<img src="https://blog.headforcloud.com/content/images/2017/10/Capture.PNG" width="90" height="90" />  <img src="https://carlos.mendible.com/assets/img/posts/aks.png" width="90" height="90" />   <img src="https://azure.microsoft.com/svghandler/container-registry/?width=600&height=315" width="90" height="90" /> <img src="data:image/png;base64,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" width="90" height="90" /> <a href="https://dd3hq3hnmbuiz.cloudfront.net/images/Terraform-Background.jpg"> <img src="https://cdn-images-1.medium.com/max/1600/1*Nsme583Ut1TY6IDZjKl27w.png" width="90" height="90" /> <img src="https://cdn-images-1.medium.com/max/1600/1*kV56ClDz_rrMg5wT4lpQ5Q.png" width="90" height="90" />
  
  
Table of Contents (Azure Kubernetes Service with Terraform)
=================

1. [ServicePrincipal and Subscription ID](#serviceprincipal-and-subscription-id)
2. [Install terraform locally](#install-terraform-locally)
3. [Automatic provisioning](#automatic-provisioning)
   * [All in one with docker azure-cli-python](#all-in-one-with-docker-azure-cli-python)
      * [kubeconfig](#kubeconfig)
      * [Sanity](#sanity)
4. [Manual stepped provisioning](#manual-stepped-provisioning)
   * [ Run Azure cli container and copy terraform binary along with id_rsa to it](#run-azure-cli-container-and-copy-terraform-binary-along-with-id_rsa-to-it)
   * [Clone this repo in the azure-cli-python container](#clone-this-repo-in-the-azure-cli-python-container)
   * [Fill in the variables.tf with default values](#fill-in-the-variables-file-with-default-values)
   * [Terraform for aks](#terraform-for-aks)
   * [kubeconfig](#kubeconfig)
   * [Sanity](#sanity)
5. [Reporting bugs](#reporting-bugs)
6. [Patches and pull requests](#patches-and-pull-requests)

### ServicePrincipal and Subscription ID
`docker run -ti docker4x/create-sp-azure aksadmin`

`Your access credentials ==================================================`

`AD ServicePrincipal App ID:       xxxxxx `

`AD ServicePrincipal App Secret:   xxxxxx `

`AD ServicePrincipal Tenant ID:   xxxxxx`

### Install terraform locally
`wget https://releases.hashicorp.com/terraform/0.11.7/terraform_0.11.7_linux_amd64.zip -O temp.zip; unzip temp.zip; rm temp.zip ;sudo cp terraform /usr/local/bin`
### Automatic provisioning 
#### All in one with docker azure-cli-python
Please note **docker** should be installed with **terraform** binary and your **id_rsa.pub** present in directory for running the following.

>**Terraform locally installed has binary in `/usr/local/bin`**

Create new cluster -Please note **docker** should be installed with **terraform** binary and your **id_rsa.pub** present in directory for running the following.

**`wget https://raw.githubusercontent.com/dwaiba/aks-terraform/master/create_cluster.sh && chmod +x create_cluster && ./create_cluster.sh`**

Terraform will now prompt for the 6 variables as below in sequence:

* azure_container_registry_name 
* client_id
* client_secret
* cluster_name
* dns_prefix
* resource_group_name

Values and conventions for the 6 variables are as follows : 
* azure_container_registry_name as "alphanumeric"
* client_id which is the sp client Id
* client_secret which is the secret for the above as created in pre-req
* cluster_name as "--org--_aks_--yournameorBU--"
* dns_prefix as "--org--aks--yournameorBU--"
* resource_group_name as "--org--_aks_--yournameorBU--"

> The DNSPrefix must contain between 3 and 45 characters and can contain only letters, numbers, and hyphens.  It must start with a letter and must end with a letter or a number. 

> Only alpha numeric characters only are allowed in azure_container_registry_name.

>Expected account_tier for storage to be one of **Standard** **Premium** with max **GRS** and **not RAGRS**. `storage_account_id` can only be specified for a **Classic (unmanaged)** Sku of Azure Container Registry. This does not support web hooks. Default is **Premium** Sku of Azure Container Registry.
  
After Cluster creation  all you need to do is perform "kubectl get svc" to get url for jenkins and obtain jenkins password as follows- preferably from within the container prompt post creation:

`printf $(kubectl get secret --namespace default hclaks-jenkins -o jsonpath="{.data.jenkins-admin-password}" | base64 -d);echo`

One can also use draft with the Container Registry and use helm to install any chart.

#### KUBECONFIG
`echo "$(terraform output kube_config)" > ~/.kube/azurek8s`

Also one can echo and copy content to local kubectl config.


`export KUBECONFIG=~/.kube/azurek8s`

#### Sanity
`kubectl get nodes`

`kubectl proxy`

Dashboard available at `http://localhost:8001/api/v1/namespaces/kube-system/services/kubernetes-dashboard/proxy/#!/overview?namespace=default`.

### Manual stepped provisioning
#### Run Azure cli container and copy terraform binary along with id_rsa to it

`docker run -dti --name=azurecli-python --restart=always azuresdk/azure-cli-python && docker cp terraform azure-cli-python:/ && docker cp ~/.ssh/id_rsa azure-cli-python:/ && docker exec -ti azure-cli-python bash -c "az login && bash"`

#### Clone this repo in the azure-cli-python container
`git clone https://github.com/dwaiba/aks-terraform`

`curl -LO https://storage.googleapis.com/kubernetes-release/release/$(curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt)/bin/linux/amd64/kubectl;`

Optionally, you can also install kubectl locally. This repo installs kubectl in the azure-cli-python container.


`chmod +x ./kubectl;`

`mv ./kubectl /usr/local/bin/kubectl;`

`mv /id_rsa.pub /aks-terraform;`

#### Fill in the variables file with default values

#### Terraform for aks
`mv ~/terraform aks-terraform/`
`cd aks-terraform`
`terraform init`

`terraform plan -out run.plan`

`terraform apply "run.plan"`

#### KUBECONFIG
`echo "$(terraform output kube_config)" > ~/.kube/azurek8s`

Also one can echo and copy content to local kubectl config.


`export KUBECONFIG=~/.kube/azurek8s`

#### Sanity
`kubectl get nodes`

`kubectl proxy`

Dashboard available at `http://localhost:8001/api/v1/namespaces/kube-system/services/kubernetes-dashboard/proxy/#!/overview?namespace=default`

### Reporting bugs

Please report bugs  by opening an issue in the [GitHub Issue Tracker](https://github.com/dwaiba/aks-terraform/issues)

### Patches and pull requests

Patches can be submitted as GitHub pull requests. If using GitHub please make sure your branch applies to the current master as a 'fast forward' merge (i.e. without creating a merge commit). Use the `git rebase` command to update your branch to the current master if necessary.
